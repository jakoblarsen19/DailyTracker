<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Daily Momentum Tracker</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Momentum" />
  <meta name="theme-color" content="#0f172a" />
  <style>
    :root{
      --bg: #0b1221; --panel:#0f172a; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#60a5fa; --accent2:#34d399; --purple:#a78bfa; --grid:rgba(148,163,184,.2);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1221 0%, #0d1426 100%);color:var(--text);font:16px/1.45 -apple-system,BlinkMacSystemFont,Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif;-webkit-font-smoothing:antialiased}
    .wrap{max-width:1100px;margin:0 auto;padding:env(safe-area-inset-top) 16px calc(24px + env(safe-area-inset-bottom));}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin:10px 0 12px}
    h1{font-size:22px;margin:0;font-weight:700}
    .sub{color:var(--muted);font-size:13px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:rgba(15,23,42,.8);backdrop-filter: blur(8px);border:1px solid rgba(148,163,184,.15);padding:14px;border-radius:var(--radius)}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    button, select, input[type="date"]{background:#0b1221;border:1px solid rgba(148,163,184,.28);color:var(--text);height:36px;border-radius:12px;padding:0 12px;cursor:pointer}
    button.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;color:#061017;font-weight:700}

    /* Grid */
    .grid{width:100%;overflow:auto;border-radius:var(--radius);border:1px solid rgba(148,163,184,.15)}
    table{border-collapse:separate;border-spacing:0;width:100%;background:rgba(2,6,23,.6)}
    thead th{position:sticky;top:0;background:linear-gradient(180deg, rgba(15,23,42,.9), rgba(15,23,42,.75));backdrop-filter: blur(8px)}
    th, td{padding:10px;border-bottom:1px solid var(--grid);border-right:1px solid var(--grid)}
    th:first-child, td:first-child{position:sticky;left:0;background:linear-gradient(180deg, rgba(15,23,42,.95), rgba(15,23,42,.75));backdrop-filter: blur(8px);z-index:2}
    th:last-child, td:last-child{border-right:0}
    tr:last-child td{border-bottom:0}
    th{font-weight:600;color:#c7d2fe}
    .section{white-space:nowrap}
    .cat-row td{font-weight:700;color:#c7d2fe;background:rgba(96,165,250,.08);border-top:2px solid rgba(148,163,184,.25)}

    .box{display:flex;align-items:center;justify-content:center;gap:8px;user-select:none}
    .check{width:28px;height:28px;border-radius:10px;border:1.5px solid rgba(148,163,184,.45);display:inline-flex;align-items:center;justify-content:center;cursor:pointer;transition:.15s;background:rgba(2,6,23,.35)}
    .check.checked{border-color:transparent;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#0b1221;font-weight:800}

    /* Progress */
    .progress-row{display:grid;grid-template-columns:1fr auto;gap:12px}
    .progress{display:flex;gap:8px;align-items:center}
    .bar{flex:1;height:10px;border-radius:999px;background:rgba(148,163,184,.18);overflow:hidden}
    .bar > i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2))}
    .label{min-width:140px;color:#c7d2fe;font-weight:600}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Daily Momentum Tracker</h1>
        <div class="sub">Track tiny wins across <strong>Physical Energy</strong> and <strong>Mental Energy</strong>.</div>
      </div>
      <div class="controls">
        <label style="display:flex;align-items:center;gap:8px">
          Start: <input id="startDate" type="date" />
        </label>
        <select id="weekSelect" title="Select week">
          <option value="0">Week 1</option>
          <option value="7">Week 2</option>
          <option value="14">Week 3</option>
        </select>
        <button class="primary" id="todayBtn">Jump to Today</button>
      </div>
    </header>

    <div class="row" style="margin:8px 0 14px">
      <div class="card" style="flex:1;min-width:280px">
        <div class="progress-row" style="margin-bottom:8px">
          <div class="label">Physical Energy</div>
          <div class="progress" style="min-width:240px">
            <div class="bar"><i id="bar-physical"></i></div>
            <div id="pct-physical" style="width:46px;text-align:right"></div>
          </div>
        </div>
        <div class="progress-row">
          <div class="label">Mental Energy</div>
          <div class="progress" style="min-width:240px">
            <div class="bar"><i id="bar-mental"></i></div>
            <div id="pct-mental" style="width:46px;text-align:right"></div>
          </div>
        </div>
      </div>
      <div class="card" style="display:flex;gap:10px;align-items:center">
        <button id="resetBtn">Reset 21‑day run</button>
        <button id="exportBtn">Export</button>
        <input id="importInput" type="file" accept="application/json" style="display:none" />
        <button id="importBtn">Import</button>
      </div>
    </div>

    <div class="grid card">
      <table id="grid">
        <thead>
          <tr>
            <th class="section">Item</th>
            <th>Day 1</th><th>Day 2</th><th>Day 3</th><th>Day 4</th><th>Day 5</th><th>Day 6</th><th>Day 7</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <footer style="margin-top:10px;color:#94a3b8;font-size:12px">
      Data is stored locally on your device via <code>localStorage</code>. Export a backup if needed.
    </footer>
  </div>

<script>
(function(){
  // Categories & sub-items (Purpose removed for now)
  const CATEGORIES = [
    {
      key: 'physical', label: 'Physical Energy', color: 'accent',
      items: [
        { key:'mealprep', label:'Meal Prep' },
        { key:'sleep', label:'Sleep' }
      ]
    },
    {
      key: 'mental', label: 'Mental Energy', color: 'purple',
      items: [
        { key:'screen', label:'< 2h Screen Time' },
        { key:'journal', label:'Journaling' }
      ]
    }
  ];

  const DAYS = 21; // total run

  // Flatten items with category mapping
  const ITEMS = [];
  CATEGORIES.forEach((cat, cIdx) => {
    cat.items.forEach(it => ITEMS.push({ ...it, catIndex:cIdx }));
  });

  const el = (sel) => document.querySelector(sel);
  const gridBody = el('#tbody');
  const startDateInput = el('#startDate');
  const weekSelect = el('#weekSelect');

  const STORAGE_KEY = 'momentum.v2';
  const state = load() || initState();

  function initState(){
    const today = new Date();
    const startISO = today.toISOString().slice(0,10);
    return {
      start: startISO,
      checks: Array.from({length: ITEMS.length}, () => Array(DAYS).fill(false))
    };
  }

  function load(){
    try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)); }catch(e){ return null; }
  }
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

  function setStartDate(iso){ state.start = iso; save(); render(); }

  function currentDayIndex(){
    const s = new Date(state.start + 'T00:00:00');
    const now = new Date();
    const diff = Math.floor((now - s) / (1000*60*60*24));
    return Math.min(Math.max(diff, 0), DAYS-1);
  }

  function dayLabel(i){ return 'Day ' + (i+1); }

  function buildWeek(offset){
    gridBody.innerHTML = '';
    const start = offset;
    const end = Math.min(offset + 7, DAYS);

    // header labels
    const thead = document.querySelector('thead tr');
    thead.innerHTML = '<th class="section">Item</th>' +
      Array.from({length: end-start}, (_,i)=>`<th>${dayLabel(start+i)}</th>`).join('');

    // rows grouped by category
    let rowIndex = 0; // maps into state.checks
    CATEGORIES.forEach((cat, cIdx) => {
      // Category header row
      const catTr = document.createElement('tr');
      catTr.className = 'cat-row';
      const catTd = document.createElement('td');
      catTd.colSpan = (end-start) + 1; // item column + days
      catTd.textContent = cat.label;
      catTr.appendChild(catTd);
      gridBody.appendChild(catTr);

      // Item rows
      cat.items.forEach((it) => {
        const tr = document.createElement('tr');
        const left = document.createElement('td');
        left.className = 'section';
        left.textContent = it.label;
        tr.appendChild(left);

        for(let d=start; d<end; d++){
          const td = document.createElement('td');
          const btn = document.createElement('div');
          const checked = state.checks[rowIndex][d];
          btn.className = 'check' + (checked ? ' checked' : '');
          btn.setAttribute('role','checkbox');
          btn.setAttribute('aria-checked', checked);
          btn.title = `${cat.label} – ${it.label} – ${dayLabel(d)}`;
          btn.textContent = checked ? '✓' : '';
          btn.addEventListener('click', () => {
            state.checks[rowIndex][d] = !state.checks[rowIndex][d];
            save();
            renderProgress();
            btn.classList.toggle('checked');
            btn.textContent = state.checks[rowIndex][d] ? '✓' : '';
            btn.setAttribute('aria-checked', state.checks[rowIndex][d]);
          });
          const box = document.createElement('div');
          box.className = 'box';
          box.appendChild(btn);
          td.appendChild(box);
          tr.appendChild(td);
        }
        gridBody.appendChild(tr);
        rowIndex++;
      });
    });
  }

  function renderCategoryProgress(){
    // Compute % per category
    CATEGORIES.forEach((cat, cIdx) => {
      const itemIndexes = ITEMS.map((it, idx) => it.catIndex === cIdx ? idx : -1).filter(i => i !== -1);
      const total = itemIndexes.length * DAYS;
      const done = itemIndexes.reduce((acc, idx) => acc + state.checks[idx].filter(Boolean).length, 0);
      const pct = total ? Math.round((done/total)*100) : 0;
      const bar = document.querySelector('#bar-' + cat.key);
      const txt = document.querySelector('#pct-' + cat.key);
      if(bar){ bar.style.width = pct + '%'; }
      if(txt){ txt.textContent = pct + '%'; }
    });
  }

  function render(){
    startDateInput.value = state.start;
    const todayIdx = currentDayIndex();
    const weekOffset = Math.floor(todayIdx/7)*7;
    weekSelect.value = String(weekOffset);

    // Build week grid
    buildWeek(weekOffset);
    renderCategoryProgress();
  }

  // controls
  startDateInput.addEventListener('change', e => setStartDate(e.target.value));
  weekSelect.addEventListener('change', e => { buildWeek(parseInt(e.target.value,10)); });
  document.querySelector('#todayBtn').addEventListener('click', () => { render(); });
  document.querySelector('#resetBtn').addEventListener('click', () => {
    if(confirm('Reset your 21‑day run? This clears all checkmarks.')){
      const startISO = new Date().toISOString().slice(0,10);
      state.start = startISO;
      state.checks = Array.from({length: ITEMS.length}, () => Array(DAYS).fill(false));
      save();
      render();
    }
  });

  // export / import
  document.querySelector('#exportBtn').addEventListener('click', () => {
    const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'momentum-data.json'; a.click();
    URL.revokeObjectURL(url);
  });
  document.querySelector('#importBtn').addEventListener('click', () => document.querySelector('#importInput').click());
  document.querySelector('#importInput').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if(!file) return;
    try{
      const text = await file.text();
      const data = JSON.parse(text);
      if(!data.start || !Array.isArray(data.checks)) throw new Error('Invalid file');
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      location.reload();
    }catch(err){ alert('Could not import file.'); }
  });

  render();
})();
</script>
</body>
</html>
